
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pedidos - Alfajores</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B6F47 0%, #D2B48C 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        h1 {
            color: #6F4E37;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .settings-icon {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 40px;
            height: 40px;
            background: #8B6F47;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
            color: white;
        }

        .settings-icon:hover {
            background: #6F4E37;
            transform: rotate(90deg);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #6F4E37;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-btn:hover {
            color: #333;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            color: #6F4E37;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #8B6F47 0%, #6F4E37 100%);
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #6F4E37;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B6F47;
        }

        button {
            background: linear-gradient(135deg, #8B6F47 0%, #6F4E37 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .kiosk-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .kiosk-item {
            background: #FFF8DC;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #8B6F47;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kiosk-info h3 {
            color: #6F4E37;
            margin-bottom: 5px;
        }

        .kiosk-info p {
            color: #8B6F47;
            font-size: 14px;
            margin: 3px 0;
        }

        .quantity-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .quantity-group {
            flex: 1;
        }

        .quantity-group label {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .quantity-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-input button {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 20px;
        }

        .quantity-input input {
            width: 80px;
            text-align: center;
        }

        .delete-btn {
            background: #A0522D;
            padding: 8px 15px;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #8B4513;
        }

        .delete-order-btn {
            background: #c0392b;
            padding: 4px 10px;
            font-size: 12px;
            margin-left: 8px;
        }

        .delete-order-btn:hover {
            background: #e74c3c;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #8B6F47 0%, #6F4E37 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 32px;
            font-weight: bold;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #FFF8DC;
            border-radius: 8px;
            border: 2px solid #DEB887;
        }

        .checkbox-group input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #8B4513;
            font-size: 16px;
        }

        .week-section {
            margin-bottom: 30px;
            border: 2px solid #8B6F47;
            border-radius: 10px;
            overflow: hidden;
        }

        .week-header {
            background: linear-gradient(135deg, #8B6F47 0%, #6F4E37 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .week-stats {
            font-size: 14px;
            opacity: 0.9;
        }

        .kiosk-orders {
            background: white;
            padding: 20px;
        }

        .kiosk-order-item {
            background: #FFF8DC;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 5px solid #8B6F47;
            cursor: pointer;
            transition: all 0.3s;
        }

        .kiosk-order-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .kiosk-order-item.pending {
            border-left-color: #A0522D;
            background: #FFE4B5;
        }

        .kiosk-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .kiosk-order-header h4 {
            color: #6F4E37;
            margin: 0;
        }

        .pending-badge {
            background: #A0522D;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .paid-badge {
            background: #8B6F47;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .order-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            color: #8B6F47;
            font-size: 14px;
        }

        .order-details-grid p {
            margin: 5px 0;
        }

        .order-detail-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #D2B48C;
            display: none;
        }

        .order-detail-list.show {
            display: block;
        }

        .individual-order {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #8B6F47;
        }

        .individual-order.pending {
            border-left-color: #A0522D;
            background: #FFF8DC;
        }

        .individual-order p {
            margin: 5px 0;
            font-size: 13px;
        }

        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .expand-icon {
            font-size: 12px;
            margin-left: 5px;
            transition: transform 0.3s;
        }

        .expanded .expand-icon {
            transform: rotate(180deg);
        }

        .price-display {
            background: #FFF8DC;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #DEB887;
        }

        .price-display h4 {
            color: #6F4E37;
            margin-bottom: 10px;
        }

        .price-display p {
            color: #8B4513;
            font-size: 18px;
            font-weight: 600;
            margin: 5px 0;
        }

        .currency-input {
            position: relative;
        }

        .currency-input::before {
            content: '$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            color: #8B6F47;
        }

        .currency-input input {
            padding-left: 28px;
        }

        .price-tag {
            color: #6F4E37;
            font-weight: 600;
            font-size: 16px;
        }

        .pay-button {
            background: #CD853F;
            padding: 6px 12px;
            font-size: 13px;
        }

        .pay-button:hover {
            background: #B8860B;
        }

        .price-info {
            background: #FFF8DC;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 3px solid #CD853F;
        }

        .price-info p {
            color: #8B4513;
            font-size: 13px;
            margin: 3px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #E3F2FD;
            color: #1976D2;
            border-left: 4px solid #2196F3;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            color: #6F4E37;
            display: none;
            z-index: 9999;
        }

        .sync-status.show {
            display: block;
        }

        small {
            display: block;
            margin-top: 5px;
            color: #8B6F47;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6F4E37;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🍪 Gestor de Pedidos de Alfajores</h1>
            <p>Sistema de gestión para kioscos</p>
            <div class="settings-icon" onclick="openSettings()">⚙️</div>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('kiosks')">Kioscos</button>
            <button class="tab-button" onclick="switchTab('orders')">Nuevo Pedido</button>
            <button class="tab-button" onclick="switchTab('history')">Historial por Semanas</button>
        </div>

        <div id="kiosks" class="tab-content active">
            <h2>Gestión de Kioscos</h2>
            <div class="form-group">
                <label>Nombre del Kiosco</label>
                <input type="text" id="kioskName" placeholder="Ej: Kiosco La Esquina">
            </div>
            <div class="form-group">
                <label>Dueño</label>
                <input type="text" id="kioskOwner" placeholder="Ej: Juan Pérez">
            </div>
            <div class="form-group">
                <label>Dirección</label>
                <input type="text" id="kioskAddress" placeholder="Ej: Av. Principal 123">
            </div>
            <div class="form-group">
                <label>Teléfono</label>
                <input type="tel" id="kioskPhone" placeholder="Ej: 11-1234-5678">
            </div>
            <button onclick="addKiosk()">Agregar Kiosco</button>

            <div class="kiosk-list" id="kioskList"></div>
        </div>

        <div id="orders" class="tab-content">
            <h2>Crear Nuevo Pedido</h2>
            <div class="form-group">
                <label>Seleccionar Kiosco</label>
                <select id="orderKiosk">
                    <option value="">Seleccione un kiosco</option>
                </select>
            </div>
            
            <div class="quantity-controls">
                <div class="quantity-group">
                    <label>Cajas de 1 Docena (12 unidades)</label>
                    <div class="quantity-input">
                        <button onclick="changeQuantity('fullBox', -1)">-</button>
                        <input type="number" id="fullBox" value="0" min="0" readonly>
                        <button onclick="changeQuantity('fullBox', 1)">+</button>
                    </div>
                </div>
                <div class="quantity-group">
                    <label>Cajas de Media Docena (6 unidades)</label>
                    <div class="quantity-input">
                        <button onclick="changeQuantity('halfBox', -1)">-</button>
                        <input type="number" id="halfBox" value="0" min="0" readonly>
                        <button onclick="changeQuantity('halfBox', 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="pendingPayment">
                <label for="pendingPayment">⚠️ Pago pendiente (no abonó)</label>
            </div>

            <button onclick="createOrder()" style="margin-top: 20px;">Crear Pedido</button>

            <div class="price-display" id="orderPrice">
                <h4>💰 Valor del Pedido</h4>
                <p>Total: $0</p>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h2>Historial por Semanas</h2>
            <div class="stats" id="stats"></div>
            <button onclick="exportData()">📥 Descargar Respaldo</button>
            <div class="loading" id="loadingHistory">Cargando datos...</div>
            <div class="order-list" id="orderList" style="margin-top: 30px;"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Configuración de Precios</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Precio Caja de 1 Docena (12 unidades)</label>
                <div class="currency-input">
                    <input type="number" id="priceFullBox" min="0" step="0.01" placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <label>Precio Caja de Media Docena (6 unidades)</label>
                <div class="currency-input">
                    <input type="number" id="priceHalfBox" min="0" step="0.01" placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <label>Precio por Docena (cuando compra 5 o más docenas)</label>
                <div class="currency-input">
                    <input type="number" id="priceBulkBox" min="0" step="0.01" placeholder="0.00">
                </div>
                <small>Este precio se aplicará automáticamente cuando el pedido tenga 5 o más docenas</small>
            </div>

            <button onclick="savePrices()">💾 Guardar Precios</button>

            <div class="price-display" style="margin-top: 20px;">
                <h4>📊 Precios Actuales</h4>
                <p id="currentPrices">Cargando...</p>
            </div>
        </div>
    </div>

    <div class="sync-status" id="syncStatus">⏳ Sincronizando...</div>

    <script>
        // Configuración GitHub (hardcodeada y ofuscada)
        const _tk = ['Z2hwX1dKaE9B', 'bWZHdVBtT1', 'JpRTZDZGgw', 'ekRERzNtRF', 'NGRnMjhnbVE='];
        const REPO_OWNER = 'PuebloMaya';
        const REPO_NAME = 'PuebloMaya';
        
        function _dt() {
            return _tk.map(p => atob(p)).join('');
        }

        let appData = {
            kioscos: [],
            pedidos: [],
            precios: {
                fullBox: 0,
                halfBox: 0,
                bulkBox: 0
            }
        };

        let currentSha = {
            kioscos: null,
            pedidos: null,
            precios: null
        };

        // ============================================
        // FUNCIONES DE GITHUB API
        // ============================================

        async function leerArchivoGitHub(archivo) {
            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${archivo}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${_dt()}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.status === 404) {
                    return { datos: null, sha: null };
                }

                if (response.ok) {
                    const data = await response.json();
                    const contenido = atob(data.content);
                    const datos = JSON.parse(contenido);
                    return { datos, sha: data.sha };
                }

                return { datos: null, sha: null };
            } catch (error) {
                console.error('Error leyendo de GitHub:', error);
                return { datos: null, sha: null };
            }
        }

        async function escribirArchivoGitHub(archivo, datos, sha = null) {
            const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${archivo}`;
            
            const contenidoJSON = JSON.stringify(datos, null, 2);
            const contenidoBase64 = btoa(unescape(encodeURIComponent(contenidoJSON)));

            const payload = {
                message: `Actualización de ${archivo}`,
                content: contenidoBase64
            };

            if (sha) {
                payload.sha = sha;
            }

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${_dt()}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.content.sha;
                }

                return null;
            } catch (error) {
                console.error('Error escribiendo en GitHub:', error);
                return null;
            }
        }

        async function syncData(silent = false) {
            if (!silent) {
                showSyncStatus('⏳ Cargando datos...');
            }

            try {
                const kioscos = await leerArchivoGitHub('kioscos.json');
                if (kioscos.datos) {
                    appData.kioscos = kioscos.datos;
                    currentSha.kioscos = kioscos.sha;
                }

                const pedidos = await leerArchivoGitHub('pedidos.json');
                if (pedidos.datos) {
                    appData.pedidos = pedidos.datos;
                    currentSha.pedidos = pedidos.sha;
                }

                const precios = await leerArchivoGitHub('precios.json');
                if (precios.datos) {
                    appData.precios = precios.datos;
                    currentSha.precios = precios.sha;
                }

                displayKiosks();
                updateKioskSelect();
                displayOrdersByWeek();
                displayStats();
                updateCurrentPricesDisplay();
                updateOrderPrice();

                if (!silent) {
                    showSyncStatus('✅ Datos cargados');
                    setTimeout(() => hideSyncStatus(), 2000);
                }
            } catch (error) {
                console.error('Error en sincronización:', error);
                if (!silent) {
                    showSyncStatus('❌ Error al cargar datos');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        async function guardarEnGitHub(silent = false) {
            if (!silent) {
                showSyncStatus('💾 Guardando...');
            }

            try {
                const newKioscosSha = await escribirArchivoGitHub('kioscos.json', appData.kioscos, currentSha.kioscos);
                if (newKioscosSha) currentSha.kioscos = newKioscosSha;

                const newPedidosSha = await escribirArchivoGitHub('pedidos.json', appData.pedidos, currentSha.pedidos);
                if (newPedidosSha) currentSha.pedidos = newPedidosSha;

                const newPreciosSha = await escribirArchivoGitHub('precios.json', appData.precios, currentSha.precios);
                if (newPreciosSha) currentSha.precios = newPreciosSha;

                if (!silent) {
                    showSyncStatus('✅ Guardado');
                    setTimeout(() => hideSyncStatus(), 2000);
                }
                return true;
            } catch (error) {
                console.error('Error guardando en GitHub:', error);
                if (!silent) {
                    showSyncStatus('❌ Error al guardar');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
                return false;
            }
        }

        function showSyncStatus(message) {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.classList.add('show');
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').classList.remove('show');
        }

        // ============================================
        // FUNCIONES DE CÁLCULO Y FORMATO
        // ============================================

        function calculatePrice(fullBox, halfBox) {
            let total = 0;
            
            if (fullBox >= 5 && appData.precios.bulkBox > 0) {
                total = fullBox * appData.precios.bulkBox;
            } else {
                total = fullBox * appData.precios.fullBox;
            }
            
            total += halfBox * appData.precios.halfBox;
            return total;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 2
            }).format(price);
        }

        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? -6 : 1 - day;
            
            const monday = new Date(d);
            monday.setDate(d.getDate() + diff);
            monday.setHours(0, 0, 0, 0);
            
            const friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);
            friday.setHours(23, 59, 59, 999);
            
            return { monday, friday };
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function getWeekLabel(monday) {
            const friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);
            return `${formatDate(monday)} - ${formatDate(friday)}`;
        }

        // ============================================
        // FUNCIONES DE UI
        // ============================================

        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            loadPrices();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'orders') {
                updateKioskSelect();
            }
            if (tabName === 'history') {
                displayOrdersByWeek();
                displayStats();
            }
        }

        // ============================================
        // KIOSCOS
        // ============================================

        async function addKiosk() {
            const name = document.getElementById('kioskName').value.trim();
            const owner = document.getElementById('kioskOwner').value.trim();
            const address = document.getElementById('kioskAddress').value.trim();
            const phone = document.getElementById('kioskPhone').value.trim();

            if (!name) {
                alert('Por favor ingrese el nombre del kiosco');
                return;
            }

            const kiosk = {
                id: Date.now(),
                name,
                owner,
                address,
                phone,
                createdAt: new Date().toISOString()
            };

            appData.kioscos.push(kiosk);
            const exito = await guardarEnGitHub();

            if (exito) {
                document.getElementById('kioskName').value = '';
                document.getElementById('kioskOwner').value = '';
                document.getElementById('kioskAddress').value = '';
                document.getElementById('kioskPhone').value = '';

                displayKiosks();
                alert('Kiosco agregado exitosamente');
            } else {
                alert('Error al guardar kiosco');
            }
        }

        function displayKiosks() {
            const list = document.getElementById('kioskList');
            
            if (appData.kioscos.length === 0) {
                list.innerHTML = '<div class="empty-state">No hay kioscos registrados. Agregue uno para comenzar.</div>';
                return;
            }

            list.innerHTML = appData.kioscos.map(kiosk => `
                <div class="kiosk-item">
                    <div class="kiosk-info">
                        <h3>${kiosk.name}</h3>
                        <p>👤 Dueño: ${kiosk.owner || 'No especificado'}</p>
                        <p>📍 ${kiosk.address || 'Sin dirección'}</p>
                        <p>📞 ${kiosk.phone || 'Sin teléfono'}</p>
                    </div>
                    <button class="delete-btn" onclick="deleteKiosk(${kiosk.id})">Eliminar</button>
                </div>
            `).join('');
        }

        async function deleteKiosk(id) {
            if (confirm('¿Está seguro de eliminar este kiosco?')) {
                appData.kioscos = appData.kioscos.filter(k => k.id !== id);
                await guardarEnGitHub();
                displayKiosks();
                updateKioskSelect();
            }
        }

        function updateKioskSelect() {
            const select = document.getElementById('orderKiosk');
            select.innerHTML = '<option value="">Seleccione un kiosco</option>' +
                appData.kioscos.map(k => `<option value="${k.id}">${k.name}</option>`).join('');
        }

        // ============================================
        // PEDIDOS
        // ============================================

        function changeQuantity(type, delta) {
            const input = document.getElementById(type);
            let value = parseInt(input.value) || 0;
            value = Math.max(0, value + delta);
            input.value = value;
            updateOrderPrice();
        }

        function updateOrderPrice() {
            const fullBox = parseInt(document.getElementById('fullBox').value) || 0;
            const halfBox = parseInt(document.getElementById('halfBox').value) || 0;
            const total = calculatePrice(fullBox, halfBox);
            
            let priceInfo = '';
            if (fullBox >= 5 && appData.precios.bulkBox > 0) {
                priceInfo = `<div class="price-info">
                    <p>✨ Precio mayorista aplicado (5+ docenas)</p>
                    <p>Precio por docena: ${formatPrice(appData.precios.bulkBox)}</p>
                </div>`;
            }
            
            document.getElementById('orderPrice').innerHTML = `
                <h4>💰 Valor del Pedido</h4>
                <p>Total: ${formatPrice(total)}</p>
                ${priceInfo}
            `;
        }

        async function createOrder() {
            const kioskId = parseInt(document.getElementById('orderKiosk').value);
            const fullBox = parseInt(document.getElementById('fullBox').value) || 0;
            const halfBox = parseInt(document.getElementById('halfBox').value) || 0;
            const pendingPayment = document.getElementById('pendingPayment').checked;

            if (!kioskId) {
                alert('Por favor seleccione un kiosco');
                return;
            }

            if (fullBox === 0 && halfBox === 0) {
                alert('Por favor agregue al menos una caja al pedido');
                return;
            }

            const kiosk = appData.kioscos.find(k => k.id === kioskId);
            const now = new Date();
            const orderPrice = calculatePrice(fullBox, halfBox);
            const isBulkPrice = fullBox >= 5 && appData.precios.bulkBox > 0;
            
            const order = {
                id: Date.now(),
                kioskId,
                kioskName: kiosk.name,
                fullBox,
                halfBox,
                totalUnits: (fullBox * 12) + (halfBox * 6),
                price: orderPrice,
                isBulkPrice,
                pendingPayment,
                createdAt: now.toISOString(),
                date: formatDate(now)
            };

            appData.pedidos.push(order);
            const exito = await guardarEnGitHub();

            if (exito) {
                document.getElementById('orderKiosk').value = '';
                document.getElementById('fullBox').value = '0';
                document.getElementById('halfBox').value = '0';
                document.getElementById('pendingPayment').checked = false;
                updateOrderPrice();

                alert('Pedido creado exitosamente');
            } else {
                alert('Error al crear pedido');
            }
        }

        async function deleteOrder(orderId) {
            if (confirm('¿Está seguro de eliminar este pedido? Esta acción no se puede deshacer.')) {
                appData.pedidos = appData.pedidos.filter(o => o.id !== orderId);
                const exito = await guardarEnGitHub();
                if (exito) {
                    displayOrdersByWeek();
                    displayStats();
                    alert('Pedido eliminado exitosamente');
                } else {
                    alert('Error al eliminar pedido');
                }
            }
        }

        async function markAsPaid(orderId) {
            const order = appData.pedidos.find(o => o.id === orderId);
            if (order) {
                order.pendingPayment = false;
                const exito = await guardarEnGitHub();
                if (exito) {
                    displayOrdersByWeek();
                    displayStats();
                    alert('Pedido marcado como pagado');
                } else {
                    alert('Error al actualizar pedido');
                }
            }
        }

        // ============================================
        // HISTORIAL
        // ============================================

        function displayOrdersByWeek() {
            const list = document.getElementById('orderList');
            const loading = document.getElementById('loadingHistory');
            
            if (appData.pedidos.length === 0) {
                loading.style.display = 'none';
                list.innerHTML = '<div class="empty-state">No hay pedidos registrados.</div>';
                return;
            }

            loading.style.display = 'none';

            const weekGroups = {};
            appData.pedidos.forEach(order => {
                const orderDate = new Date(order.createdAt);
                const { monday } = getWeekRange(orderDate);
                const weekKey = monday.toISOString();
                
                if (!weekGroups[weekKey]) {
                    weekGroups[weekKey] = {
                        monday,
                        orders: []
                    };
                }
                weekGroups[weekKey].orders.push(order);
            });

            const sortedWeeks = Object.values(weekGroups).sort((a, b) => 
                b.monday.getTime() - a.monday.getTime()
            );

            list.innerHTML = sortedWeeks.map(week => {
                const kioskGroups = {};
                week.orders.forEach(order => {
                    if (!kioskGroups[order.kioskId]) {
                        kioskGroups[order.kioskId] = {
                            kioskName: order.kioskName,
                            orders: []
                        };
                    }
                    kioskGroups[order.kioskId].orders.push(order);
                });

                const weekTotal = {
                    fullBox: week.orders.reduce((sum, o) => sum + o.fullBox, 0),
                    halfBox: week.orders.reduce((sum, o) => sum + o.halfBox, 0),
                    totalUnits: week.orders.reduce((sum, o) => sum + o.totalUnits, 0),
                    totalPrice: week.orders.reduce((sum, o) => sum + (o.price || 0), 0),
                    pending: week.orders.filter(o => o.pendingPayment).length
                };

                return `
                    <div class="week-section">
                        <div class="week-header">
                            <h3>📅 Semana: ${getWeekLabel(week.monday)}</h3>
                            <div class="week-stats">
                                Docenas: ${weekTotal.fullBox} | Medias: ${weekTotal.halfBox} | 
                                Total: ${weekTotal.totalUnits} unidades | 
                                💰 ${formatPrice(weekTotal.totalPrice)}
                                ${weekTotal.pending > 0 ? ` | ⚠️ ${weekTotal.pending} pendiente(s)` : ''}
                            </div>
                        </div>
                        <div class="kiosk-orders">
                            ${Object.values(kioskGroups).map(kioskGroup => {
                                const kioskTotal = {
                                    fullBox: kioskGroup.orders.reduce((sum, o) => sum + o.fullBox, 0),
                                    halfBox: kioskGroup.orders.reduce((sum, o) => sum + o.halfBox, 0),
                                    totalUnits: kioskGroup.orders.reduce((sum, o) => sum + o.totalUnits, 0),
                                    totalPrice: kioskGroup.orders.reduce((sum, o) => sum + (o.price || 0), 0),
                                    hasPending: kioskGroup.orders.some(o => o.pendingPayment),
                                    pendingCount: kioskGroup.orders.filter(o => o.pendingPayment).length
                                };

                                const kioskId = kioskGroup.orders[0].kioskId;
                                const uniqueId = `kiosk-${kioskId}-${week.monday.getTime()}`;

                                return `
                                    <div class="kiosk-order-item ${kioskTotal.hasPending ? 'pending' : ''}" onclick="toggleOrderDetails('${uniqueId}')">
                                        <div class="kiosk-order-header">
                                            <h4>${kioskGroup.kioskName} <span class="expand-icon">▼</span></h4>
                                            ${kioskTotal.hasPending ? 
                                                `<span class="pending-badge">⚠️ ${kioskTotal.pendingCount} PEDIDO(S) PENDIENTE(S)</span>` : 
                                                '<span class="paid-badge">✓ PAGADO</span>'}
                                        </div>
                                        <div class="order-details-grid">
                                            <p><strong>Pedidos:</strong> ${kioskGroup.orders.length}</p>
                                            <p><strong>Docenas:</strong> ${kioskTotal.fullBox}</p>
                                            <p><strong>Medias:</strong> ${kioskTotal.halfBox}</p>
                                            <p><strong>Total:</strong> ${kioskTotal.totalUnits} unidades</p>
                                            <p class="price-tag"><strong>💰 Total:</strong> ${formatPrice(kioskTotal.totalPrice)}</p>
                                        </div>
                                        <div class="order-detail-list" id="${uniqueId}">
                                            <h5 style="margin-bottom: 10px; color: #6F4E37;">📋 Detalle de pedidos:</h5>
                                            ${kioskGroup.orders.map((order, index) => `
                                                <div class="individual-order ${order.pendingPayment ? 'pending' : ''}">
                                                    <p><strong>Pedido #${index + 1}</strong> - ${order.date}</p>
                                                    <p>🍪 Docenas: ${order.fullBox} | Medias: ${order.halfBox} | Total: ${order.totalUnits} unidades</p>
                                                    ${order.isBulkPrice ? '<p style="color: #CD853F; font-size: 12px;">✨ Precio mayorista aplicado</p>' : ''}
                                                    <p class="price-tag">💰 ${formatPrice(order.price || 0)}</p>
                                                    <p style="color: ${order.pendingPayment ? '#A0522D' : '#8B6F47'}; font-weight: 600;">
                                                        ${order.pendingPayment ? '⚠️ DEBE PAGAR ESTE PEDIDO' : '✓ Pagado'}
                                                    </p>
                                                    <div class="order-actions">
                                                        ${order.pendingPayment ? 
                                                            `<button class="pay-button" onclick="event.stopPropagation(); markAsPaid(${order.id})">Marcar como Pagado</button>` : 
                                                            '<span style="color: #8B6F47; font-size: 12px;">✓ Pagado</span>'}
                                                        <button class="delete-order-btn" onclick="event.stopPropagation(); deleteOrder(${order.id})">🗑️ Eliminar</button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${kioskTotal.hasPending ? `
                                                <div style="background: #FFF8DC; padding: 12px; border-radius: 6px; margin-top: 10px; border: 2px solid #DEB887;">
                                                    <p style="color: #8B4513; font-weight: 600; margin: 0;">
                                                        💰 Total adeudado: ${formatPrice(kioskGroup.orders.filter(o => o.pendingPayment)
                                                            .reduce((sum, o) => sum + (o.price || 0), 0))}
                                                    </p>
                                                    <p style="color: #8B4513; margin: 5px 0 0 0; font-size: 13px;">
                                                        ${kioskGroup.orders.filter(o => o.pendingPayment)
                                                            .reduce((sum, o) => sum + o.totalUnits, 0)} unidades
                                                        (${kioskGroup.orders.filter(o => o.pendingPayment)
                                                            .reduce((sum, o) => sum + o.fullBox, 0)} docenas + 
                                                        ${kioskGroup.orders.filter(o => o.pendingPayment)
                                                            .reduce((sum, o) => sum + o.halfBox, 0)} medias)
                                                    </p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleOrderDetails(id) {
            const element = document.getElementById(id);
            const parent = element.parentElement;
            
            if (element.classList.contains('show')) {
                element.classList.remove('show');
                parent.classList.remove('expanded');
            } else {
                element.classList.add('show');
                parent.classList.add('expanded');
            }
        }

        function displayStats() {
            const totalOrders = appData.pedidos.length;
            const totalFullBoxes = appData.pedidos.reduce((sum, o) => sum + o.fullBox, 0);
            const totalHalfBoxes = appData.pedidos.reduce((sum, o) => sum + o.halfBox, 0);
            const totalUnits = appData.pedidos.reduce((sum, o) => sum + o.totalUnits, 0);
            const pendingPayments = appData.pedidos.filter(o => o.pendingPayment).length;

            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <h4>Total Pedidos</h4>
                    <p>${totalOrders}</p>
                </div>
                <div class="stat-card">
                    <h4>Cajas Docena</h4>
                    <p>${totalFullBoxes}</p>
                </div>
                <div class="stat-card">
                    <h4>Cajas Media</h4>
                    <p>${totalHalfBoxes}</p>
                </div>
                <div class="stat-card">
                    <h4>Total Unidades</h4>
                    <p>${totalUnits}</p>
                </div>
                <div class="stat-card" style="background: ${pendingPayments > 0 ? 'linear-gradient(135deg, #A0522D 0%, #8B4513 100%)' : 'linear-gradient(135deg, #8B6F47 0%, #6F4E37 100%)'}">
                    <h4>Pagos Pendientes</h4>
                    <p>${pendingPayments}</p>
                </div>
            `;
        }

        function exportData() {
            const data = {
                kioscos: appData.kioscos,
                pedidos: appData.pedidos,
                precios: appData.precios,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pedidos-alfajores-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // ============================================
        // PRECIOS
        // ============================================

        async function savePrices() {
            const fullBox = parseFloat(document.getElementById('priceFullBox').value) || 0;
            const halfBox = parseFloat(document.getElementById('priceHalfBox').value) || 0;
            const bulkBox = parseFloat(document.getElementById('priceBulkBox').value) || 0;

            if (fullBox < 0 || halfBox < 0 || bulkBox < 0) {
                alert('Los precios no pueden ser negativos');
                return;
            }

            appData.precios = { fullBox, halfBox, bulkBox };
            const exito = await guardarEnGitHub();

            if (exito) {
                updateCurrentPricesDisplay();
                alert('Precios guardados exitosamente');
            } else {
                alert('Error al guardar precios');
            }
        }

        function loadPrices() {
            document.getElementById('priceFullBox').value = appData.precios.fullBox;
            document.getElementById('priceHalfBox').value = appData.precios.halfBox;
            document.getElementById('priceBulkBox').value = appData.precios.bulkBox;
            updateCurrentPricesDisplay();
        }

        function updateCurrentPricesDisplay() {
            document.getElementById('currentPrices').innerHTML = `
                Docena: ${formatPrice(appData.precios.fullBox)}<br>
                Media: ${formatPrice(appData.precios.halfBox)}<br>
                Mayorista (5+): ${formatPrice(appData.precios.bulkBox)}
            `;
        }

        // ============================================
        // INICIALIZACIÓN
        // ============================================

        window.addEventListener('load', async function() {
            await syncData(false);
            
            // Sincronización automática cada 60 segundos
            setInterval(() => {
                syncData(true);
            }, 60000);
        });
    </script>
</body>
</html>
